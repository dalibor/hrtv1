:javascript
  var _response_id = "#{@response.id}";
  var _type        = "#{params[:id]}";

- content_for :sub_nav do
  = render 'shared/sub_nav_projects'

%h1.main_heading Workplan

= render 'workplan_getting_started'

%ul.horizontal
  %li
    - link_to '#', :id => "import_export", :class => 'create_button js_upload_btn' do
      = image_tag "icon_import_export.png"
      Import / Export

#import_export_box
  = render '/projects/activities_import', :project => nil, :can_export => @response.activities.present?


- form_tag response_workplan_path(@response, params[:id]), :method => :put, :id => 'workplan' do
  %table.workplan
    %thead
      %tr.filler
        %th{:colspan => 3}
        %th.no-padding{:colspan => 6}
          %ul.tabs
            %li= link_to 'Yearly', edit_response_workplan_path(@response, :spend), :class => (params[:id] == 'spend' ? 'active' : nil)
            %li= link_to 'Quarterly', edit_response_workplan_path(@response, :budget), :class => (params[:id] == 'budget' ? 'active' : nil)
      %tr.head
        %th{:colspan => 3}
        - start_year = @response.request.start_date.try(:year)
        - end_year = @response.request.end_date.try(:year)
        - if start_year == end_year
          - prev_fy = "FY #{start_year}"
          - next_fy = "FY #{start_year+1}"
        - else
          - prev_fy = "FY #{start_year}-#{end_year}"
          - next_fy = "FY #{start_year+1}-#{end_year+1}"
        %th= prev_fy
        %th{:colspan => 10}= next_fy
      %tr.head
        %th Project
        %th{:colspan => 2} Activity / Other Cost
        %th Spend
        %th Budget
    %tbody
      - @projects.each do |project|
        %tr.js_project_row
          %td.name.wrap-10{:rowspan => project.activities.length + project.other_costs.length + 4}
            = link_to project.name, edit_response_project_path(@response, project)
        %tr.activity_subheading
          %td{:colspan => 100} Activities
        - project.activities.ordered_by_id.each do |activity|
          = render 'activity_row', :activity => activity, :type => params[:id]
        %tr.activity_subheading
          %td{:colspan => 100} Other Costs
        - project.other_costs.ordered_by_id.each do |activity|
          = render 'activity_row', :activity => activity, :type => params[:id]

        %tr.filler2.js_project_total_row{:"data-project_id" => project.id}
          %td
            - link_to new_response_activity_path(@response, :project_id => project.id), :class => 'add_activity add_row' do
              = image_tag "new.png"
              Add activity
            &nbsp;
            - link_to new_response_other_cost_path(@response, :project_id => project.id), :class => 'add_activity add_row' do
              = image_tag "new.png"
              Add other cost
          %td.total Subtotal
          %td.total_amount
            %span.js_spend_column_total= project.converted_activities_total_by_type('spend', false)
            %span.currency= @response.currency

          %td.total_amount
            %span.js_budget_column_total= project.converted_activities_total_by_type('budget', false)
            %span.currency= @response.currency
      %tr.filler.js_projects_total_row
        %td{:colspan => 2}
          - link_to new_response_project_path(@response), :class => 'js_add_project add_row' do
            = image_tag "new.png"
            Add project

        %td.total Total
        %td.total_amount.wrap-10
          %span.js_projects_total_spend_amount
            = @projects.map{ |p| p.converted_activities_total_by_type('spend', false)}.compact.sum
          %span.currency= @response.currency
        %td.total_amount.wrap-10
          %span.js_projects_total_budget_amount
            = @projects.map{ |p| p.converted_activities_total_by_type('budget', false)}.compact.sum
          %span.currency= @response.currency
      %tr
        %td.borderless{:colspan => 8}
          = submit_tag :Save, :style => (@projects.detect{|p| p.activities.present? } ? nil : 'display: none;'), :class => 'save_btn right big'


- if @projects.empty?
  %p.centered.attention Hi! Click "Add Project" to get started
  %p.centered.attention Or you can Import your workplan from a file.
