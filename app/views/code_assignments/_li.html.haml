- updater_field = 'updates' # @coding_type + '_updates'
- assignment = @current_assignments[code.id] if @current_assignments.has_key?(code.id)
- amount     = assignment.nil? ? '' : assignment.amount
- percentage = assignment.nil? ? '' : assignment.percentage
- cached_amount = assignment.nil? ? '' : assignment.cached_amount
- invalid_class = assignment && !@coding_tree.valid_ca?(assignment) ? 'invalid' : nil

%div.clearfix{:class => invalid_class}
  .left
    = check_box_tag "activity[code_assignment_tree][]", code.id, @current_assignments.has_key?(code.id)
    = label_tag "activity[#{updater_field}][#{code.id}][amount]", "#{code.short_display}"
    = link_to "?", "#", :title => code.description, :class => "tooltip info" if code.description
  .values.right
    .left
      = text_field_tag "activity[#{updater_field}][#{code.id}][amount]", n2c(amount), :size => 14
      .greyed or
      = text_field_tag "activity[#{updater_field}][#{code.id}][percentage]", h(percentage), :size => 2
      = label_tag "activity[#{updater_field}][#{code.id}][percentage]", "%"
      - cached_label = cached_amount.blank? ? "" : "#{n2c(cached_amount)}"
    = label_tag "activity[#{updater_field}][#{code.id}][cached_amount]", cached_label, :id => nil, :class => "subtotal"

  - if invalid_class
    = link_to "!", "#" , :title => node_error(code, assignment), :class => "tooltip info invalid_node"
