- budget_fiscal_year = @response.organization.gor_fiscal_year_start(:budget).map{ |y| y.to_s.last(2) }.join("-")
- spend_fiscal_year = budget_fiscal_year_prev = @response.organization.gor_fiscal_year_start(:budget).map{ |y| (y - 1).to_s.last(2) }.join("-")
- spend_fiscal_year_prev = @response.organization.gor_fiscal_year_start(:budget).map{ |y| (y - 2).to_s.last(2) }.join("-")

.header
  - if activity.valid?
    = image_tag "tick_12.png"
    = nice_name(activity, 50)
  - else
    .left
      = image_tag "warning_12.png", :title => "This activity has not been saved because you need to add more information and/or correct any errors. Click here to open the activity if it is closed", :class => 'tooltip'
      = nice_name(activity, 50)

      %span.project= activity.project.try(:name)
    %ul.right
      - if activity.start_date.present? && activity.end_date.present?
        %li
          %span Period:
          = activity.start_date.strftime("%d.%m.%Y")
          -
          = activity.end_date.strftime("%d.%m.%Y")
      %li
        %span Past Expenditure:
        = "#{activity.spend} #{activity.currency}"
      %li
        %span Current Budget:
        = "#{activity.budget} #{activity.currency}"

.main.dashboard_section{:style => (activity.valid? && params[:format] != 'js' ? 'display: none;' : nil)}
  - semantic_form_for activity, :namespace => form_namespace(activity), :url => (bulk_edit_activity_path(activity, response) ), :html => {:class => "condensed_form"} do |f|

    - f.inputs :class => 'inputs_condensed' do
      %li
        %ul
          =  f.input :csv_project_name, :as => :hidden
          =  f.input :csv_provider, :as => :hidden
          =  f.input :csv_beneficiaries, :as => :hidden
      %li
        - unless f.object.project
          %ul.response-notice
            %li== We didn't find the project "#{activity.csv_project_name}" in the list, please select the correct one
            %br

        %ul.clearfix
          = f.input :project_id, :label => "Project", :input_html => {:class => 'activity_project_id'}, :wrapper_html => {:class => 'activity_project'}, :as => :select, :collection => @response.projects

      %li
        %ul
          = f.input :name, :required => false, :wrapper_html => {:class => 'grid-30'}
          = f.input :description, :input_html => { :rows => 2 }, :required => false, :wrapper_html => {:class => 'grid-40'}
          = f.input :start_date, :as => :string, :input_html => {:class => 'date_picker'}, :wrapper_html => {:class => 'short_input'}, :required => false, :wrapper_html => {:class => 'grid-15'}
          = f.input :end_date, :as => :string, :input_html => {:class => 'date_picker'}, :wrapper_html => {:class => 'short_input'}, :required => false, :wrapper_html => {:class => 'grid-15'}

      %li
        %ul.first-half
          = f.input :spend, :required => false, :label => 'Expenditure', :wrapper_html => {:class => 'grid-20'}
          %li
            %label Quarterly Expenditure
            %ul
              = f.input :spend_q4_prev, :required => false, :wrapper_html => {:class => 'grid-15'}, :input_html => {'data-hint' => "Q4 #{spend_fiscal_year_prev}"}, :label => false
              = f.input :spend_q1     , :required => false, :wrapper_html => {:class => 'grid-15'}, :input_html => {'data-hint' => "Q1 #{spend_fiscal_year}"}, :label => false
              = f.input :spend_q2     , :required => false, :wrapper_html => {:class => 'grid-15'}, :input_html => {'data-hint' => "Q2 #{spend_fiscal_year}"}, :label => false
              = f.input :spend_q3     , :required => false, :wrapper_html => {:class => 'grid-15'}, :input_html => {'data-hint' => "Q3 #{spend_fiscal_year}"}, :label => false
              = f.input :spend_q4     , :required => false, :wrapper_html => {:class => 'grid-15'}, :input_html => {'data-hint' => "Q4 #{spend_fiscal_year}"}, :label => false

        %ul.second-half
          = f.input :budget, :label => "Current Budget", :required => false, :wrapper_html => {:class => 'grid-20'}
          %li.grid-80
            %label Quarterly budget
            %ul
              = f.input :budget_q4_prev, :required => false, :wrapper_html => {:class => 'grid-20'}, :input_html => {'data-hint' => "Q4 #{budget_fiscal_year_prev}"}, :label => false
              = f.input :budget_q1     , :required => false, :wrapper_html => {:class => 'grid-20'}, :input_html => {'data-hint' => "Q1 #{budget_fiscal_year}"}, :label => false
              = f.input :budget_q2     , :required => false, :wrapper_html => {:class => 'grid-20'}, :input_html => {'data-hint' => "Q2 #{budget_fiscal_year}"}, :label => false
              = f.input :budget_q3     , :required => false, :wrapper_html => {:class => 'grid-20'}, :input_html => {'data-hint' => "Q3 #{budget_fiscal_year}"}, :label => false
              = f.input :budget_q4     , :required => false, :wrapper_html => {:class => 'grid-20'}, :input_html => {'data-hint' => "Q4 #{budget_fiscal_year}"}, :label => false

      %li
        - unless f.object.provider
          %ul.response-notice
            %li= "We couldn't find the implementer #{activity.csv_provider} in the list, please select the correct one"
            %br


        - if f.object.csv_beneficiaries.present? && f.object.beneficiaries.length != f.object.csv_beneficiaries.to_s.split(',').length
          %ul.response-notice
            %li= "We didn't find all the beneficiaries #{activity.csv_beneficiaries} in the list, please check the correct ones"
            %br


        %ul
          = f.input :provider_mask, :label => "Implementer", :as => :select, :collection => Organization.reporting.ordered, :required => false, :input_html => {:class => 'js_implementer_select js_combobox'}, :wrapper_html => {:class => 'fourth'}

          = f.input :text_for_beneficiaries, :input_html => { :rows => 2 }, :as => :text, :required => false, :wrapper_html => {:class => 'fourth'}, :label => "Beneficiary details / Other beneficiaries"
          = f.input :beneficiaries, :as => :check_boxes, :label => "Beneficiaries", :wrapper_html => {:class => 'fourth'}

      %li.borderless.marginless
        %br
        - f.buttons :class => 'buttons' do
          = f.commit_button "Save", :wrapper_html => {:class => "save_btn left"}, :button_html => {:class => "next"}
          = image_tag "ajax-loader.gif", :class => "ajax-loader", :style => 'display: none;'
