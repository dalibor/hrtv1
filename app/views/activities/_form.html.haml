- sorted_projects = @response.projects.sort_by{|p| p.name}.collect{|u| [u.name, u.id]}

:javascript
  var _response_id = "#{@response.id}";
  var _activity_id = "#{@activity.id}";
  var _funding_sources = #{get_funding_sources(current_user.organization.projects)};

- f.inputs :class => 'inputs' do
  %li.last
    %h3 Basics
    %ul.dashboard_section.condensed_fields
      %li#activity_name_input.string.required
        .name
          = f.label :name, "Name"
          %span.required *
          = link_to "(?)", "#", :title => "A short name for this activity", :class => 'tooltip remaining_characters'
        = f.text_field :name, "data-maxlength" => "#{Activity::MAX_NAME_LENGTH}"
      %li#activity_start_date_input.string.required
        .name
          = f.label :start_date, "Start date"
          %span.required *
          = link_to "(?)", "#", :title => "(YYYY-MM-DD) The date when the Activity started.", :class => 'tooltip'
        = f.text_field :start_date, :class => 'date_picker'
      %li#activity_end_date_input.string.required
        .name
          = f.label :end_date, "End date"
          %span.required *
          = link_to "(?)", "#", :title => "(YYYY-MM-DD) The date when the Activity finishes.", :class => 'tooltip'
        = f.text_field :end_date, :class => 'date_picker'
      %li#activity_currency_input.select.required
        .name
          = f.label :currency, "Currency"
          = link_to "(?)", "#", :title => "The default (Organization) currency or the Project currency, if selected", :class => 'tooltip'
        %span.noedit= f.object.currency
      %li#activity_project_id_input.select.required
        .name
          = f.label :project_id, "Project"
          = link_to "(?)", "#", :title => "The Project which this Activity belongs to", :class => 'tooltip'
        = f.select :project_id, [['Select a project...', '']] + sorted_projects.insert(0,["<Automatically create a project for me>", -1])
      //hack
      %br
      %li#activity_description_input.text
        .name
          = f.label :description, "Description"
          = link_to "(?)", "#", :title => "A general 1-2 sentence description of the purpose of the Activity.", :class => 'tooltip'
        = f.text_area :description, :rows => 2


      // Old code for reference
      //
      //= f.input :project_id, :label => "Project", :as => :select, :collection => sorted_projects.insert(0,["<Automatically create a project for me>", -1]) , :hint => "The Project this activity correlates to", :prompt => 'Select a project...'
      //= f.input :name, :hint => "A short name for this Activity."
      //= f.input :description, :input_html => { :rows => 2 }, :hint => "A longer description of this Activity."
      //= f.input :start_date, :as => :string, :label => "Start date", :input_html => {:class => 'date_picker'}, :hint => "(YYYY-MM-DD) The date when the Activity started."
      //= f.input :end_date, :as => :string, :label => "End date", :input_html => {:class => 'date_picker'}, :hint => "(YYYY-MM-DD) The end date for the Activityâ€™s implementation."

  %li.last.sub_activities
    = render 'activities/implementers', :f => f


  %li.last.targets.js_targets
    %h3 Activity Targets
    .dashboard_section
      %p.heading_hint
        %strong Optional.
        Describe planned targets for this activity.

      - f.semantic_fields_for :targets do |ca|
        = render "activities/target_fields", :f => ca
      .add
        = link_to_add_fields "Add Target", f, :targets, "activities/", :class => "create_alt marginless js_add_nested"

  %li.last.targets.js_targets
    %h3 Activity Outputs
    .dashboard_section
      %p.heading_hint
        %strong Optional.
        Describe actual outputs for this activity.

      - f.semantic_fields_for :outputs do |ca|
        = render "activities/output_fields", :f => ca
      .add
        = link_to_add_fields "Add Output", f, :outputs, "activities/", :class => "create_alt marginless js_add_nested"

  %li.last
    %h3== Other
    %ul.dashboard_section.single_column
      = f.input :beneficiaries, :as => :check_boxes, :label => "Beneficiary details / Other beneficiaries", :hint => "Beneficiaries of your Activity, if applicable to any of these population groups."
      = f.input :text_for_beneficiaries, :input_html => { :rows => 2 }, :label => "Other beneficiaries", :as => :text, :required => false, :hint => "Beneficiaries of your Activity that are not listed above."

  %li
    %ul.horizontal.borderless
      - f.buttons :class => 'buttons1' do
        = f.commit_button "Save", :button_html => {:class => "last big_button"}
        = f.commit_button "Save & Classify >", :button_html => {:class => "last big_button"}
        %li
          = link_to "Cancel", response_projects_path(@response), :class => "js_toggle_projects_listing add_row cancel_button last"

- unless @activity.new_record?
  .delete_section
    = link_to "Delete this Activity", response_activity_path(@response, @activity), :confirm => "Are you sure you want to delete this Activity?", :method => :delete, :class => "delete_button", :class => 'delete_action'
    %p
      %strong Warning:
      Once you delete an Activity, you will lose all data associated with it, and there is no undo.
